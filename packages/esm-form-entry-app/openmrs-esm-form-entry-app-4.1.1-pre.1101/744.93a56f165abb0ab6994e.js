"use strict";(self["webpackJsonpopenmrs-esm-form-entry"]=self["webpackJsonpopenmrs-esm-form-entry"]||[]).push([[744],{744:(Ne,$,d)=>{d.r($),d.d($,{bootstrap:()=>Ie,mount:()=>je,unmount:()=>ke});var V=d(5566),r=d(6018),J=d(3175),ue=d(8570),f=d(4435);const B=new f.ReplaySubject(1);var E=d(4531),O=d(5),P=d(8185),h=d(9745),de=d(9308),x=d(6015),F=d(7128),Z=d(6558),m=d(6512);const I="patient-form";let z=(()=>{class n{constructor(){}getCurrentUser(){return(0,m.getCurrentUser)().pipe((0,h.U)(e=>e.user))}openmrsFetch(e){return(0,m.openmrsObservableFetch)(e)}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var g=d(5258),R=d(6191);let L=(()=>{class n{constructor(e,t){this.http=e,this.windoRef=t,this.v="custom:(uuid,encounterDatetime,patient:(uuid,uuid),form:(uuid,name),visit:(uuid,display,auditInfo,startDatetime,stopDatetime,location:(uuid,display),visitType:(uuid,name)),location:ref,encounterType:ref,encounterProviders:(uuid,display,provider:(uuid,display)))"}getUrl(){return this.windoRef.openmrsRestBase}getEncountersByPatientUuid(e,t=!1,o=null){if(!e)return null;const i=this.getUrl()+"encounter";let s=(new g.LE).set("patient",e).set("v",this.v);return this.http.get(i,{params:s}).pipe((0,x.VS)(a=>a.results.length>=500?(s=s.set("startIndex","500"),this.http.get(i,{params:s}).pipe((0,h.U)(u=>a.results.concat(u.results)))):(0,f.of)(a.results)))}getEncounterByUuid(e){if(!e)return null;const o=(new g.LE).set("v","custom:(uuid,encounterDatetime,patient:(uuid,uuid,person,identifiers:full),form:(uuid,name),visit:(uuid,visitType,display,startDatetime,stopDatetime),location:ref,encounterType:ref,encounterProviders:(uuid,display,provider:(uuid,display)),orders:full,obs:(uuid,obsDatetime,formFieldNamespace,formFieldPath,concept:(uuid,uuid,name:(display)),value:ref,groupMembers),diagnoses:(uuid,diagnosis,certainty,rank,voided,display))"),i=this.getUrl()+"encounter/"+e;return this.http.get(i,{params:o})}getEncounterTypes(e){if(!e)return null;const t=this.getUrl()+"encountertype";return this.http.get(t).pipe((0,h.U)(o=>o.results))}saveEncounter(e){if(!e)return null;const t=this.getUrl()+"encounter",o=new g.WM({"Content-Type":"application/json"});return this.http.post(t,JSON.stringify(e),{headers:o})}updateEncounter(e,t){if(!t||!e)return null;const o=this.getUrl()+"encounter/"+e,i=new g.WM({"Content-Type":"application/json"});return this.http.post(o,JSON.stringify(t),{headers:i})}voidEncounter(e){if(!e)return null;const t=this.getUrl()+"encounter/"+e+"?!purge",o=new g.WM({"Content-Type":"application/json"});return this.http.delete(t,{headers:o})}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var Q=d(4488),he=d(192),fe=d(6290);function ge(n){j(n);for(const c of["obs.concept"])k(n,c);return n}function j(n){if("object"==typeof n)for(const[c,e]of Object.entries(n))"uuid"!==c&&"string"==typeof e&&(0,fe.Z)(e)?q(n,c):"object"==typeof e&&j(e);else if(Array.isArray(n))for(const c of n)j(c);return n}function k(n,c){const[e,...t]=c.split(".");if(0===t.length)return void q(n,e);const o=null==n?void 0:n[e];if(Array.isArray(o))for(const i of o)k(i,t.join("."));else"object"==typeof o&&k(o,t.join("."))}function q(n,c){return"object"==typeof n&&"string"==typeof n[c]&&(n[c]={uuid:n[c]}),n}var ve=d(4213),M=d(8666);let G=(()=>{class n{constructor(e,t){this.http=e,this.windowRef=t,this.v="full"}getUrl(){return this.windowRef.openmrsRestBase+"person"}getPersonByUuid(e,t=null){let o=this.getUrl();o+="/"+e;const i=(new g.LE).set("v",t&&t.length>0?t:this.v);return this.http.get(o,{params:i})}saveUpdatePerson(e,t){if(!t||!e)return null;const o=`${this.getUrl()}/${e}`,i=new g.WM({"Content-Type":"application/json"});return this.http.post(o,JSON.stringify(t),{headers:i}).pipe((0,h.U)(s=>s.person))}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var me=d(7273);let K=(()=>{class n{constructor(e,t,o){this.http=e,this.windowRef=t,this.personService=o}searchProvider(e){return this.getAllProviders().pipe((0,h.U)(t=>t.filter(o=>o.display.toLowerCase().includes(e.toLowerCase()))))}getProviderByUuid(e){return this.http.get(this.windowRef.openmrsRestBase+"provider/"+e+"?v="+n.v).pipe((0,F.K)(()=>this.getProviderByUuidFallback(e)))}getProviderByUuidFallback(e){return this.getAllProviders().pipe((0,h.U)(t=>t.find(o=>o.uuid===e)))}getAllProviders(){return this.http.get(this.windowRef.openmrsRestBase+"provider?q=&v="+n.v).pipe((0,h.U)(t=>t.results))}getUrl(e){return e?this.windowRef.openmrsRestBase+"provider/"+e+"?v="+n.v:this.windowRef.openmrsRestBase+"provider?q=&v="+n.v}}return n.v="custom:(uuid,display,person:(uuid))",n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X),r.LFG(G))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),H=(()=>{class n{constructor(e,t){this.http=e,this.windowRef=t}getLocationByUuid(e){const t=this.getUrl(e);return this.http.get(t).pipe((0,F.K)(()=>this.getLocationByUuidFallback(e)))}getLocationByUuidFallback(e){return this.getAllLocations().pipe((0,h.U)(t=>t.find(o=>o.uuid===e)))}searchLocation(e){return this.getAllLocations().pipe((0,h.U)(t=>t.filter(o=>o.display.toLowerCase().includes(e.toLowerCase()))))}getAllLocations(){const e=this.getUrl();return this.http.get(e).pipe((0,h.U)(t=>t.results))}getUrl(e){return e?this.windowRef.openmrsRestBase+"location/"+e+"?v="+n.v:this.windowRef.openmrsRestBase+"location?q=&v="+n.v}}return n.v="custom:(uuid,display)",n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),X=(()=>{class n{constructor(e,t){this.http=e,this.windowRef=t,this.v="custom:(uuid,name,conceptClass,setMembers)"}getUrl(){return this.windowRef.openmrsRestBase+"concept"}searchConcept(e,t=!1,o=null){const i=this.getUrl(),s=(new g.LE).set("q",e).set("v",o&&o.length>0?o:this.v);return this.http.get(i,{params:s}).pipe((0,h.U)(a=>a.results))}getConceptByUuid(e,t=!1,o=this.v){let i=this.getUrl();i+="/"+e;const s=(new g.LE).set("v",o&&o.length>0?o:this.v);return this.http.get(i,{params:s})}getConceptByConceptClassesUuid(e,t){let o=[];return this.searchConcept(e).pipe((0,P.q)(1)).subscribe(s=>{o=this.filterResultsByConceptClassesUuid(s,t)},s=>{}),o}filterResultsByConceptClassesUuid(e,t){return e.filter(i=>t.find(s=>i.conceptClass.uuid===s))}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var ee=d(2115);let N=(()=>{class n{constructor(e,t,o,i){this.providerResourceService=e,this.locationResourceService=t,this.conceptResourceService=o,this.localStorageService=i}getDataSources(e){return{location:{resolveSelectedValue:this.getLocationByUuid.bind(this),searchOptions:this.findLocation.bind(this)},provider:{resolveSelectedValue:this.getProviderByUuid.bind(this),searchOptions:this.findProvider.bind(this)},drug:{resolveSelectedValue:this.resolveConcept.bind(this),searchOptions:this.findDrug.bind(this)},problem:{resolveSelectedValue:this.resolveConcept.bind(this),searchOptions:this.findProblem.bind(this)},diagnoses:{resolveSelectedValue:this.resolveConcept.bind(this),searchOptions:this.findDiagnoses.bind(this)},conceptAnswers:this.getWhoStagingCriteriaDataSource(),recentObs:this.getMostRecentObsDataSource(e)}}getWhoStagingCriteriaDataSource(){const e=new f.Subject,t={cachedOptions:[],dataSourceOptions:{concept:void 0},resolveSelectedValue:void 0,searchOptions:void 0,dataFromSourceChanged:e.asObservable(),changeConcept:void 0},o=a=>{if(t.cachedOptions.length>0)return f.Observable.create(l=>{l.next(t.cachedOptions)});const u=this.getConceptSetMembers(t.dataSourceOptions.concept);return u.subscribe(l=>{t.cachedOptions=l}),u};return t.resolveSelectedValue=a=>this.resolveConcept(a),t.searchOptions=o,t.changeConcept=a=>{t.dataSourceOptions.concept=a,t.cachedOptions=[],e.next([]),o().subscribe(u=>{e.next(u)})},t}getMostRecentObsDataSource(e){const t=new Set;for(const o of e.pages)for(const i of o.sections)this.extractMostRecentObsConceptIds(i.questions,t);return o=>this.fetchMostRecentObsValue(o,[...t])}extractMostRecentObsConceptIds(e,t){var o,i,s;for(const a of e){const u=null!==(i=null===(o=a.questionOptions)||void 0===o?void 0:o.useMostRecentValue)&&void 0!==i&&i;if("true"===u||"boolean"==typeof u&&u){if("string"==typeof a.concept){t.add(a.concept);continue}if("string"==typeof(null===(s=a.questionOptions)||void 0===s?void 0:s.concept)){t.add(a.questionOptions.concept);continue}Array.isArray(a.questions)&&this.extractMostRecentObsConceptIds(a.questions,t)}}}findProvider(e){return this.providerResourceService.searchProvider(e).pipe((0,h.U)(t=>t.filter(o=>!!o.person).map(this.mapProvider)),(0,me.b)(t=>this.setCachedProviderSearchResults(t)))}getProviderByUuid(e){return this.providerResourceService.getProviderByUuid(e).pipe((0,h.U)(this.mapProvider))}mapProvider(e){return e&&{label:e.display,value:e.uuid,providerUuid:e.uuid}}findLocation(e){return this.locationResourceService.searchLocation(e).pipe((0,h.U)(t=>t.map(this.mapLocation)),(0,P.q)(10))}fetchMostRecentObsValue(e,t){if(!e)throw new Error("patient must be provided in call to fetchMostRecentObsValue");if(!t)throw new Error("at least one concept must be provided in call to fetchMostRecentObsValue");if("string"==typeof t&&(t=[t]),!Array.isArray(t))throw new Error(`concepts must be supplied to fetchMostRecentObsValue as either a string or array or strings. Instead, we got ${JSON.stringify(t)}`);const o=new URLSearchParams({patient:e,code:t.join(","),max:"1",_summary:"data"});return(0,m.openmrsFetch)(`${m.fhirBaseUrl}/Observation/$lastn?${o.toString()}`).then(i=>{var s;return i.ok?null===(s=i.data.entry)||void 0===s?void 0:s.reduce((a,u)=>{var l,p,v,w,y,_;if(u.resource&&"Observation"===u.resource.resourceType&&u.resource.code){const S=null===(l=u.resource.code.coding.find(b=>!Boolean(b.system)))||void 0===l?void 0:l.code;let U;if(null!=u.resource.valueString)U=u.resource.valueString;else if(void 0!==(null===(p=u.resource.valueQuantity)||void 0===p?void 0:p.value)&&null!==(null===(v=u.resource.valueQuantity)||void 0===v?void 0:v.value))U=u.resource.valueQuantity.value;else{const b=null===(_=null===(y=null===(w=u.resource.valueCodeableConcept)||void 0===w?void 0:w.coding)||void 0===y?void 0:y.find(Ge=>!Boolean(Ge.system)))||void 0===_?void 0:_.code;null!=b&&(U={uuid:b})}null!=S&&void 0!==U&&a.obs.push({concept:{uuid:S,display:null,conceptClass:null},value:U})}return a},{obs:[]}):{obs:[]}})}getLocationByUuid(e){return this.locationResourceService.getLocationByUuid(e).pipe((0,h.U)(this.mapLocation))}mapLocation(e){return e&&{label:e.display,value:e.uuid}}resolveConcept(e){return this.conceptResourceService.getConceptByUuid(e).pipe((0,h.U)(this.mapConcept))}getConceptAnswers(e){return this.conceptResourceService.getConceptByUuid(e).pipe((0,h.U)(t=>t.answers.map(this.mapConcept)))}getConceptSetMembers(e){return this.conceptResourceService.getConceptByUuid(e).pipe((0,h.U)(t=>t.setMembers.map(this.mapConcept).sort((o,i)=>o.label>i.label?1:0)))}findDrug(e){return this.conceptResourceService.searchConcept(e).pipe((0,h.U)(o=>o.filter(i=>i.conceptClass&&"8d490dfc-c2cc-11de-8d13-0010c6dffd0f"===i.conceptClass.uuid).map(this.mapConcept)))}findProblem(e){const t=["8d4918b0-c2cc-11de-8d13-0010c6dffd0f","8d492b2a-c2cc-11de-8d13-0010c6dffd0f","8d492954-c2cc-11de-8d13-0010c6dffd0f","8d491a9a-c2cc-11de-8d13-0010c6dffd0f"];return this.conceptResourceService.searchConcept(e).pipe((0,h.U)(o=>o.filter(i=>i.conceptClass&&t.includes(i.conceptClass.uuid)).map(this.mapConcept)))}findDiagnoses(e){const t=["8d4918b0-c2cc-11de-8d13-0010c6dffd0f"];return this.conceptResourceService.searchConcept(e).pipe((0,h.U)(o=>o.filter(i=>i.conceptClass&&t.includes(i.conceptClass.uuid)).map(this.mapConcept)))}mapConcept(e){return e&&{value:e.uuid,label:e.name.display}}getCachedProviderSearchResults(){return this.localStorageService.getObject("cachedproviders")}setCachedProviderSearchResults(e){this.localStorageService.setObject("cachedproviders",e)}getPatientObject(e){const t={};return t.sex="male"===(null==e?void 0:e.gender)?"M":"F",t.birthdate=new Date(null==e?void 0:e.birthDate),t.age=this.calculateAge(null==e?void 0:e.birthDate),"female"===(null==e?void 0:e.gender)&&(t.gendercreatconstant=.85),"male"===(null==e?void 0:e.gender)&&(t.gendercreatconstant=1),t}calculateAge(e){const t=Date.now()-new Date(e).getTime(),o=new Date(t);return Math.abs(o.getUTCFullYear()-1970)}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(K),r.LFG(H),r.LFG(X),r.LFG(ee.n))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),A=(()=>{class n{constructor(){this.lastProps=void 0,this.lastPropsSubscription=B.subscribe(e=>this.lastProps=e)}ngOnDestroy(){var e;null===(e=this.lastPropsSubscription)||void 0===e||e.unsubscribe()}getPropOrThrow(e){const t=this.getProp(e);if(void 0===t){const o=new Error(`The module is missing the required Single SPA property "${e}". This is a development error likely caused by another microfrontend module. See the associated console log for details.`);throw console.error(o,this.lastProps),o}return t}getProp(e,t){var o,i;return null!==(i=null===(o=this.lastProps)||void 0===o?void 0:o[e])&&void 0!==i?i:t}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),te=(()=>{class n{constructor(e,t,o,i,s,a){this.encounterAdapter=e,this.personAttributeAdapter=t,this.encounterResourceService=o,this.personResourceService=i,this.formDataSourceService=s,this.singleSpaPropsService=a}submitPayload(e){const t=this.singleSpaPropsService.getProp("isOffline",!1),o=this.singleSpaPropsService.getProp("encounterUuid");return(0,f.from)(function(n){return(0,O.mG)(this,void 0,void 0,function*(){return(yield(0,m.getFullSynchronizationItems)(I)).find(e=>e.content._id===n)})}(o)).pipe((0,x.zg)(s=>{const a=t||!!s;a&&this.deepClearInitialNodeValues(e.rootNode);const u=this.onEncounterCreate(this.buildEncounterPayload(e)),l=this.buildPersonUpdatePayload(e);return a?this.submitPayloadOffline(e,u,l,null==s?void 0:s.content._id):this.submitPayloadOnline(u,l)}))}deepClearInitialNodeValues(e){if(e.initialValue=void 0,e.children&&"object"==typeof e.children)for(const t of Object.values(e.children))this.deepClearInitialNodeValues(t)}onEncounterCreate(e){const t=this.singleSpaPropsService.getProp("handleEncounterCreate");return t&&"function"==typeof t&&t(e),e}submitPayloadOffline(e,t,o,i){const s=ge((0,he.Z)(t)),a={encounter:s},u={_id:null!=i?i:(0,ve.Z)(),formSchemaUuid:e.schema.uuid,encounter:s,_payloads:{encounterCreate:t,personUpdate:o}};return(0,f.from)(function(n){var c,e;return(0,O.mG)(this,void 0,void 0,function*(){yield(0,m.queueSynchronizationItem)(I,n,{id:n._id,displayName:"Patient form",patientUuid:null===(c=n._payloads.encounterCreate)||void 0===c?void 0:c.patient,dependencies:[{type:"visit",id:null===(e=n._payloads.encounterCreate)||void 0===e?void 0:e.visit}]})})}(u).then(()=>a))}submitPayloadOnline(e,t){return(0,f.forkJoin)({encounter:this.submitEncounter(e),person:this.submitPersonUpdate(t)})}submitEncounter(e){return e?e.uuid?this.encounterResourceService.updateEncounter(e.uuid,e).pipe((0,F.K)(t=>this.throwUserFriendlyError(t))):this.encounterResourceService.saveEncounter(e).pipe((0,F.K)(t=>this.throwUserFriendlyError(t))):(0,f.of)(void 0)}submitPersonUpdate(e){return e?this.personResourceService.saveUpdatePerson(e.uuid,e).pipe((0,F.K)(t=>this.throwUserFriendlyError(t))):(0,f.of)(void 0)}buildEncounterPayload(e){var t,o;const i=this.formDataSourceService.getCachedProviderSearchResults();if((null==i?void 0:i.length)&&!e.valueProcessingInfo.providerUuid){const a=this.findProviderUuidFormForm(i,e);e.valueProcessingInfo.providerUuid=a}const s=this.encounterAdapter.generateFormPayload(e);return!s.hasOwnProperty("location")&&(null===(o=null===(t=e.dataSourcesContainer.dataSources)||void 0===t?void 0:t.userLocation)||void 0===o?void 0:o.uuid)&&(s.location=e.dataSourcesContainer.dataSources.userLocation.uuid),(0,Q.Z)(s)?void 0:s}findProviderUuidFormForm(e,t){var o,i;const a=null===(o=t.searchNodeByQuestionId("provider")[0])||void 0===o?void 0:o.control.value,u=null===(i=e.find(l=>l.id===a))||void 0===i?void 0:i.providerUuid;return null!=u?u:a}buildPersonUpdatePayload(e){if(!e.valueProcessingInfo.personUuid)throw new Error("The form is missing a required value for submitting person updates: form.valueProcessingInfo.personUuid");const t=this.personAttributeAdapter.generateFormPayload(e);if(!(0,Q.Z)(t))return{uuid:e.valueProcessingInfo.personUuid,attributes:t}}throwUserFriendlyError(e){var t,o,i;if("object"==typeof e){const a=Object.values(null!==(i=null===(o=null===(t=e.error)||void 0===t?void 0:t.error)||void 0===o?void 0:o.fieldErrors)&&void 0!==i?i:{}).flatMap(l=>l).map(l=>l.message),u=a.length>0?a.join(" "):e.message;throw new Error(u)}throw"string"==typeof e?new Error(e):new Error(`An unknown error occured: ${e}.`)}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(M.uN),r.LFG(M.Cr),r.LFG(L),r.LFG(G),r.LFG(N),r.LFG(A))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var Se=d(1821);let ne=(()=>{class n{constructor(e){this.encounterResource=e}getPreviousEncounter(e,t){return new Promise((o,i)=>{this.encounterResource.getEncountersByPatientUuid(t).subscribe(s=>{if(s){const a=s.sort((l,p)=>new Date(p.encounterDatetime).getTime()-new Date(l.encounterDatetime).getTime()),u=(0,Se.Z)(a,l=>l.encounterType.uuid===e);u?this.encounterResource.getEncounterByUuid(u.uuid).pipe((0,P.q)(1)).subscribe(l=>{o(l)},l=>{i(l)}):o(Object.create({}))}},s=>{console.error("Previous encounter",s)})})}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(L))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var ye=d(7953),re=d(6415);let W=(()=>{class n{getConfig(){var e;let t=null===(e=(0,m.getConfigStore)("@openmrs/esm-form-entry-app").getState())||void 0===e?void 0:e.config;return(0,m.getConfigStore)("@openmrs/esm-form-entry-app").subscribe(o=>{o.loaded&&o&&(t=o.config)}),t}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),oe=(()=>{class n{constructor(e,t,o){this.http=e,this.windowRef=t,this.configResource=o}getMonthlySchedule(e){const t=`${this.configResource.getConfig().appointmentsResourceUrl}?startDate=${e.startDate}&endDate=${e.endDate}&locationUuids=${e.locationUuids}&limit=${e.limit}&programType=${e.programType}&groupBy=groupByPerson,groupByAttendedDate,groupByRtcDate`;return this.http.get(`${this.windowRef.nativeWindow.openmrsBase}${t}`)}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X),r.LFG(W))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();const C={};let ie=(()=>{class n{constructor(e,t,o,i,s,a,u){this.formFactory=e,this.dataSources=t,this.formDataSourceService=o,this.monthlyScheduleResourceService=i,this.encounterAdapter=s,this.configResourceService=a,this.singleSpaPropsService=u}initAndCreateForm(e){return(0,O.mG)(this,void 0,void 0,function*(){const{formSchema:t,encounter:o}=e;yield this.wireDataSources(e,t);const i=this.formFactory.createForm(t,this.dataSources.dataSources);if(this.setUpWHOCascading(i),o){const s=o.uuid;this.populateEncounterForEditing(i,e),i.valueProcessingInfo.encounterUuid=s}else{const s=this.singleSpaPropsService.getPropOrThrow("patientUuid");this.setDefaultValues(i,e),i.valueProcessingInfo.patientUuid=s}return this.setUpPayloadProcessingInformation(i,e),i})}wireDataSources(e,t){return(0,O.mG)(this,void 0,void 0,function*(){const o=this.singleSpaPropsService.getPropOrThrow("visitTypeUuid"),i=this.singleSpaPropsService.getPropOrThrow("patient");for(const p of Object.keys(this.dataSources.dataSources))this.dataSources.clearDataSource(p);const s=this.formDataSourceService.getDataSources(t);this.dataSources.registerDataSource("location",s.location),this.dataSources.registerDataSource("provider",s.provider),this.dataSources.registerDataSource("drug",s.drug),this.dataSources.registerDataSource("problem",s.problem),this.dataSources.registerDataSource("personAttribute",s.location),this.dataSources.registerDataSource("conceptAnswers",s.conceptAnswers),this.dataSources.registerDataSource("diagnoses",s.diagnoses),this.dataSources.registerDataSource("patient",{visitTypeUuid:o},!0);const a=this.formDataSourceService.getPatientObject(i);this.dataSources.registerDataSource("patient",a,!0),this.dataSources.registerDataSource("rawPrevEnc",e.previousEncounter,!1);const u=yield s.recentObs(i.id);this.dataSources.registerDataSource("rawPrevObs",u,!1),this.dataSources.registerDataSource("userLocation",e.user.sessionLocation);const l=this.configResourceService.getConfig();return l.dataSources.monthlySchedule&&this.dataSources.registerDataSource("monthlyScheduleResourceService",this.monthlyScheduleResourceService),Promise.all([l.customDataSources.map(({name:p,moduleName:v,moduleExport:w})=>(0,O.mG)(this,void 0,void 0,function*(){let y=!1;if(C.hasOwnProperty(p)){if(C[p])return this.dataSources.registerDataSource(p,C[p]),Promise.resolve();y=!0}if(""===v)return y||console.warn(`A custom data source ${p} has a blank module name. A module name must be provided to register a data source correctly.`),C[p]=void 0,Promise.resolve();const _=function(n){return n.replace(/[\/\-@]/g,"_")}(v);if(!window.hasOwnProperty(_))return y||console.error(`esm-form-entry-app is configured to use the datasource ${p}, but the corresponding module ${v} has not been loaded. Most likely, this means that ${v} is not in your importmap or was not loaded prior to ending up here.`),C[p]=void 0,Promise.resolve();{const S=window[_];if(!("object"==typeof S&&S.hasOwnProperty("init")&&(0,re.Z)(S.init)&&S.hasOwnProperty("get")&&(0,re.Z)(S.get)))return y||console.error(`esm-form-app is configured to use the datasource ${p} from the module ${v}, but the version of ${v} loaded is not in the expected format. Please ensure that the version of ${v} you are loading is built as a Webpack module.`),C[p]=void 0,Promise.resolve();try{const b=(yield S.get("./start"))();return"object"==typeof b&&b.hasOwnProperty(w)?(C[p]=b[w],this.dataSources.registerDataSource(p,b[w]),Promise.resolve()):(y||console.error(`esm-form-entry-app could not load the module ${v} for the datasource ${p} because the module did not have the expected ${"default"==w?"default export":`export ${w}`}.`),C[p]=void 0,Promise.resolve())}catch(U){return y||console.error(`esm-form-entry-app could not load the datasource ${p} because ${v} did not export the expected entry "./start". Please check the Webpack configuration for ${v}.`,U),C[p]=void 0,Promise.resolve()}}}))])})}setUpWHOCascading(e){try{let t=e.searchNodeByQuestionId("adultWhoStage");0===t.length&&(t=e.searchNodeByQuestionId("pedWhoStage"));const o=t[0];null==o||o.control.valueChanges.subscribe(i=>{var s;if(i){const a=e.dataSourcesContainer.dataSources.conceptAnswers;null===(s=a.changeConcept)||void 0===s||s.call(a,i)}})}catch(t){console.error(`Error setting up WHO Staging Cascading. Error: ${JSON.stringify(t)}.`)}}setDefaultValues(e,t){const{user:o}=t,i=ye().format(),s=e.searchNodeByQuestionId("encDate");s.length>0&&s[0].control.setValue(i);const a=e.searchNodeByQuestionId("location","encounterLocation");a.length>0&&(null==o?void 0:o.sessionLocation)&&a[0].control.setValue(o.sessionLocation.uuid);const u=e.searchNodeByQuestionId("provider","encounterProvider");u.length>0&&(null==o?void 0:o.currentProvider)&&u[0].control.setValue(o.currentProvider.uuid)}setUpPayloadProcessingInformation(e,t){var o;const{user:i,formSchema:s,encounter:a}=t,u=this.singleSpaPropsService.getPropOrThrow("patientUuid"),l=this.singleSpaPropsService.getPropOrThrow("visitUuid");try{if(i){if(e.valueProcessingInfo.personUuid=u,e.valueProcessingInfo.patientUuid=u,e.valueProcessingInfo.formUuid=s.uuid,e.valueProcessingInfo.providerUuid=null===(o=i.currentProvider)||void 0===o?void 0:o.uuid,!s.encounterType)throw new Error("Please associate the form with an encounter type.");e.valueProcessingInfo.encounterTypeUuid=s.encounterType.uuid,a&&(e.valueProcessingInfo.encounterUuid=a.uuid),a||(e.valueProcessingInfo.visitUuid=l)}}catch(p){console.error(p)}}populateEncounterForEditing(e,t){const{encounter:o}=t;o&&this.encounterAdapter.populateForm(e,o)}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(M.b8),r.LFG(M.NA),r.LFG(N),r.LFG(oe),r.LFG(M.uN),r.LFG(W),r.LFG(A))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})();var se=d(1422),T=d(6387),D=d(9599);let Pe=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275cmp=r.Xpm({type:n,selectors:[["loader"]],inputs:{loadingMessage:"loadingMessage"},decls:12,vars:1,consts:[["aria-live","assertive",1,"cds--inline-loading",2,"width","fit-content"],[1,"cds--inline-loading__animation"],["aria-atomic","true","aria-labelledby","loading-id-5","aria-live","assertive",1,"cds--loading","cds--loading--small"],["id","loading-id-5",1,"cds--visually-hidden"],["viewBox","0 0 100 100",1,"cds--loading__svg"],["cx","50%","cy","50%","r","44",1,"cds--loading__background"],["cx","50%","cy","50%","r","44",1,"cds--loading__stroke"],[1,"cds--inline-loading__text"]],template:function(e,t){1&e&&(r.TgZ(0,"div",0),r.TgZ(1,"div",1),r.TgZ(2,"div",2),r.TgZ(3,"label",3),r._uU(4," Active loading indicator "),r.qZA(),r.O4$(),r.TgZ(5,"svg",4),r.TgZ(6,"title"),r._uU(7,"Active loading indicator"),r.qZA(),r._UZ(8,"circle",5),r._UZ(9,"circle",6),r.qZA(),r.qZA(),r.qZA(),r.kcU(),r.TgZ(10,"div",7),r._uU(11),r.qZA(),r.qZA()),2&e&&(r.xp6(11),r.Oqu(t.loadingMessage))},encapsulation:2}),n})();function Ce(n,c){if(1&n){const e=r.EpF();r.TgZ(0,"div",2),r.TgZ(1,"div",3),r.TgZ(2,"h4",4),r._uU(3,"There was an error with this form"),r.qZA(),r.TgZ(4,"p",5),r._uU(5," Try opening another form "),r.qZA(),r.TgZ(6,"p",6),r._uU(7,"or"),r.qZA(),r.TgZ(8,"button",7),r.NdJ("click",function(){return r.CHM(e),r.oxw().closeForm()}),r._uU(9," Close this panel "),r.qZA(),r.qZA(),r.qZA()}}function we(n,c){if(1&n&&(r.TgZ(0,"form",13),r._UZ(1,"ofe-form-renderer",14),r.qZA()),2&n){const e=r.oxw(3);r.Q6J("formGroup",e.form.rootNode.control),r.xp6(1),r.Q6J("labelMap",e.labelMap)("node",e.form.rootNode)}}function Ue(n,c){1&n&&(r.TgZ(0,"span"),r._uU(1,"Save and close"),r.qZA())}function Oe(n,c){1&n&&r._UZ(0,"loader",20)}function Fe(n,c){if(1&n){const e=r.EpF();r.TgZ(0,"div",15),r.TgZ(1,"button",16),r.NdJ("click",function(){return r.CHM(e),r.oxw(3).closeForm()}),r._uU(2,"Discard"),r.qZA(),r.TgZ(3,"button",17),r.NdJ("click",function(){return r.CHM(e),r.oxw(3).onSubmit()}),r.YNc(4,Ue,2,0,"span",18),r.YNc(5,Oe,1,0,"loader",19),r.qZA(),r.qZA()}if(2&n){const e=r.oxw(3);r.xp6(3),r.Q6J("disabled","submitting"===e.formState),r.xp6(1),r.Q6J("ngIf","submitting"!==e.formState),r.xp6(1),r.Q6J("ngIf","submitting"===e.formState)}}function Re(n,c){if(1&n&&(r.TgZ(0,"div",2),r.TgZ(1,"div"),r.YNc(2,we,2,3,"form",11),r.qZA(),r.YNc(3,Fe,6,3,"div",12),r.qZA()),2&n){const e=r.oxw(2);r.xp6(2),r.Q6J("ngIf",e.form),r.xp6(1),r.Q6J("ngIf",e.showDiscardSubmitButtons)}}function Me(n,c){1&n&&(r.TgZ(0,"div",21),r._UZ(1,"loader",22),r.qZA())}const _e=function(n){return{error:n}};function Le(n,c){if(1&n&&(r.TgZ(0,"div",8),r.TgZ(1,"div",9),r.YNc(2,Re,4,2,"div",0),r.qZA(),r.YNc(3,Me,2,0,"div",10),r.qZA()),2&n){const e=r.oxw();r.Q6J("ngClass",r.VKq(3,_e,"readyWithValidationErrors"===e.formState)),r.xp6(2),r.Q6J("ngIf","ready"===e.formState||"readyWithValidationErrors"===e.formState||"submitting"===e.formState||"submissionError"===e.formState),r.xp6(1),r.Q6J("ngIf","loading"===e.formState)}}const ae=(0,m.createGlobalStore)("ampath-form-state",{});let Ee=(()=>{class n{constructor(e,t,o,i,s,a,u,l,p,v){this.openmrsApi=e,this.formSchemaService=t,this.encounterResourceService=o,this.formSubmissionService=i,this.patientPreviousEncounter=s,this.formCreationService=a,this.singleSpaPropsService=u,this.conceptService=l,this.translateService=p,this.ngZone=v,this.labelMap={},this.formState="initial",this.showDiscardSubmitButtons=!0,this.language=window.i18next.language.substring(0,2).toLowerCase()}ngOnInit(){this.unsubscribeStore=ae.subscribe(e=>{this.formState=e[this.formUuid]}),this.changeState("initial"),this.launchForm()}ngOnDestroy(){var e;this.unsubscribeStore&&this.unsubscribeStore(),null===(e=this.launchFormSubscription)||void 0===e||e.unsubscribe()}launchForm(){var e,t;this.changeState("loading"),this.showDiscardSubmitButtons=null===(e=this.singleSpaPropsService.getProp("showDiscardSubmitButtons"))||void 0===e||e,null===(t=this.launchFormSubscription)||void 0===t||t.unsubscribe(),this.launchFormSubscription=this.loadAllFormDependencies().pipe((0,P.q)(1),(0,h.U)(o=>(0,f.from)(this.formCreationService.initAndCreateForm(o))),(0,de.u)(),(0,x.zg)(o=>(0,O.mG)(this,void 0,void 0,function*(){const i=Z.f.getUnlabeledConceptIdentifiersFromSchema(o.schema);return{form:o,concepts:yield this.conceptService.searchConceptsByIdentifiers(i).toPromise()}}))).subscribe(({form:o,concepts:i})=>{this.form=o,i&&(this.labelMap=i.reduce((s,a)=>(Boolean(a)&&(s[a.identifier]=a.display),s),{})),this.changeState("ready")},o=>{this.loadingError="Error loading form",console.error("Error rendering form",o),this.changeState("loadingError")})}loadAllFormDependencies(){var e,t,o;this.formUuid=this.singleSpaPropsService.getPropOrThrow("formUuid");const i=this.singleSpaPropsService.getPropOrThrow("encounterUuid"),s=null!==(o=null===(t=null===(e=window.i18next)||void 0===e?void 0:e.language)||void 0===t?void 0:t.substring(0,2))&&void 0!==o?o:"";return this.translateService.addLangs([s]),this.translateService.use(s),(0,f.forkJoin)({formSchema:this.fetchCompiledFormSchema(this.formUuid,s).pipe((0,P.q)(1)),user:this.openmrsApi.getCurrentUser().pipe((0,P.q)(1)),encounter:i?this.getEncounterToEdit(i).pipe((0,P.q)(1)):(0,f.of)(null)}).pipe((0,x.zg)(a=>this.loadPatientPreviousEncounters(a.formSchema).pipe((0,h.U)(u=>Object.assign(Object.assign({},a),{previousEncounter:u})))),(0,F.K)(a=>(0,f.throwError)(new Error("There was an error fetching form data. Details: "+JSON.stringify(a)))))}fetchCompiledFormSchema(e,t){return this.formSchemaService.getFormSchemaByUuid(e,t).pipe((0,P.q)(1))}getEncounterToEdit(e){return this.singleSpaPropsService.getProp("isOffline",!1)?(0,f.from)(this.getOfflineEncounterToEdit(e)):this.encounterResourceService.getEncounterByUuid(e).pipe((0,F.K)(()=>(0,f.from)(this.getOfflineEncounterToEdit(e))))}getOfflineEncounterToEdit(e){return(0,O.mG)(this,void 0,void 0,function*(){return(yield(0,m.getSynchronizationItems)(I)).find(i=>i._id===e).encounter})}loadPatientPreviousEncounters(e){var t;const o=this.singleSpaPropsService.getProp("patientUuid");return this.singleSpaPropsService.getProp("isOffline",!1)?(0,f.of)(void 0):(0,f.from)(this.patientPreviousEncounter.getPreviousEncounter(null===(t=e.encounterType)||void 0===t?void 0:t.uuid,o))}onSubmit(){!this.validateForm()||(this.changeState("submitting"),this.formSubmissionService.submitPayload(this.form).subscribe(({encounter:e})=>{this.onPostResponse(e);const t=this.singleSpaPropsService.getProp("isOffline",!1);this.changeState("submitted"),!t&&(null==e?void 0:e.uuid)&&this.encounterResourceService.getEncounterByUuid(e.uuid).pipe((0,P.q)(1)).subscribe(o=>{if(Array.isArray(null==o?void 0:o.orders)){const i=o.orders.filter(({auditInfo:s})=>!s.dateVoided);this.showLabOrdersNotification(i)}}),(0,m.showToast)({critical:!0,kind:"success",description:"The form has been submitted successfully.",title:this.form.schema.name}),this.closeForm()},e=>{this.changeState("submissionError"),(0,m.showToast)({critical:!0,kind:"error",description:`An error has occurred while submitting the form. Error: ${JSON.stringify(null==e?void 0:e.message,null,2)}.`,title:this.form.schema.name})}))}validateForm(){return this.form.valid||(this.form.markInvalidControls(this.form.rootNode),this.form.showErrors=!0,this.changeState("readyWithValidationErrors")),this.onValidate(this.form.valid),this.form.valid}showLabOrdersNotification(e=[]){var t;const o=null!==(t=e.map((i,s)=>` ${s+1} : ${i.display} : ${i.orderNumber}`).join())&&void 0!==t?t:"";o.length&&(0,m.showNotification)({title:"Lab order(s) generated",kind:"success",critical:!0,description:o})}closeForm(){this.singleSpaPropsService.getPropOrThrow("closeWorkspace")()}onPostResponse(e){const t=this.singleSpaPropsService.getProp("handlePostResponse");t&&"function"==typeof t&&t(e)}onValidate(e){const t=this.singleSpaPropsService.getProp("handleOnValidate");t&&"function"==typeof t&&t(e)}onFormAction(e){this.ngZone.run(()=>{var t,o,i;const s=this.singleSpaPropsService.getPropOrThrow("formUuid"),a=this.singleSpaPropsService.getPropOrThrow("patientUuid");if((null===(t=e.detail)||void 0===t?void 0:t.formUuid)===s&&(null===(o=e.detail)||void 0===o?void 0:o.patientUuid)===a)switch(null===(i=e.detail)||void 0===i?void 0:i.action){case"onSubmit":this.onSubmit();break;case"validateForm":this.validateForm()}})}changeState(e){if(e!=this.formState){const t={};t[this.formUuid]=e,ae.setState(t)}}}return n.\u0275fac=function(e){return new(e||n)(r.Y36(z),r.Y36(Z.f),r.Y36(L),r.Y36(te),r.Y36(ne),r.Y36(ie),r.Y36(A),r.Y36(se.F),r.Y36(T.sK),r.Y36(r.R0b))},n.\u0275cmp=r.Xpm({type:n,selectors:[["my-app-fe-wrapper"]],hostBindings:function(e,t){1&e&&r.NdJ("ampath-form-action",function(i){return t.onFormAction(i)},!1,r.Jf7)},decls:2,vars:2,consts:[["class","form-container",4,"ngIf"],[3,"ngClass",4,"ngIf"],[1,"form-container"],[1,"cds--tile","error-tile"],[1,"heading"],[1,"helperText"],[1,"separator"],[1,"cds--btn","cds--btn--sm","cds--btn--ghost",3,"click"],[3,"ngClass"],[1,"content"],["class","loader-container",4,"ngIf"],["class","cds--form no-padding",3,"formGroup",4,"ngIf"],["class","cds-btn--set button-set",4,"ngIf"],[1,"cds--form","no-padding",3,"formGroup"],[3,"labelMap","node"],[1,"cds-btn--set","button-set"],["type","button",1,"cds--btn","cds--btn--secondary",3,"click"],["type","submit",1,"cds--btn","cds--btn--primary",3,"disabled","click"],[4,"ngIf"],["loadingMessage","Submitting",4,"ngIf"],["loadingMessage","Submitting"],[1,"loader-container"],["loadingMessage","Loading...",1,"loader"]],template:function(e,t){1&e&&(r.YNc(0,Ce,10,0,"div",0),r.YNc(1,Le,4,5,"div",1)),2&e&&(r.Q6J("ngIf",t.loadingError),r.xp6(1),r.Q6J("ngIf","submitted"!==t.formState))},directives:[E.O5,E.mk,D._Y,D.JL,D.sg,M.YC,Pe],styles:['[_ngcontent-%COMP%]:root {\n  --brand-01: #005d5d;\n  --brand-02: #004144;\n  --brand-03: #007d79;\n}\n\n.error-tile[_ngcontent-%COMP%] {\n  width: 60%;\n  margin: 1.25rem auto;\n  display: flex;\n  flex-flow: column wrap;\n  align-items: center;\n  justify-content: center;\n  padding: 1.5rem 0 1.75rem;\n}\n\n.omrs-breakpoint-lt-desktop[_nghost-%COMP%]   .error-tile[_ngcontent-%COMP%], .omrs-breakpoint-lt-desktop   [_nghost-%COMP%]   .error-tile[_ngcontent-%COMP%] {\n  background-color: #ffffff;\n}\n.heading[_ngcontent-%COMP%] {\n  font-size: var(--cds-productive-heading-02-font-size, 1rem);\n  font-weight: var(--cds-productive-heading-02-font-weight, 600);\n  line-height: var(--cds-productive-heading-02-line-height, 1.375);\n  letter-spacing: var(--cds-productive-heading-02-letter-spacing, 0);\n  color: #161616;\n}\n.helperText[_ngcontent-%COMP%] {\n  margin-top: 0.5rem;\n  font-size: var(--cds-body-01-font-size, 0.875rem);\n  font-weight: var(--cds-body-01-font-weight, 400);\n  line-height: var(--cds-body-01-line-height, 1.42857);\n  letter-spacing: var(--cds-body-01-letter-spacing, 0.16px);\n  color: #262626;\n}\n.separator[_ngcontent-%COMP%] {\n  font-size: var(--cds-body-01-font-size, 0.875rem);\n  font-weight: var(--cds-body-01-font-weight, 400);\n  line-height: var(--cds-body-01-line-height, 1.42857);\n  letter-spacing: var(--cds-body-01-letter-spacing, 0.16px);\n  color: #262626;\n  width: 12rem;\n  margin: 1.375rem auto;\n  overflow: hidden;\n  text-align: center;\n}\n.separator[_ngcontent-%COMP%]::before, .separator[_ngcontent-%COMP%]::after {\n  background-color: #a8a8a8;\n  content: "";\n  display: inline-block;\n  height: 1px;\n  position: relative;\n  vertical-align: middle;\n  width: 50%;\n}\n.separator[_ngcontent-%COMP%]::before {\n  right: 1rem;\n  margin-left: -50%;\n}\n.separator[_ngcontent-%COMP%]::after {\n  left: 1rem;\n  margin-right: -50%;\n}\n.title-icon-size[_ngcontent-%COMP%] {\n  height: 0.8rem;\n  width: 0.8rem;\n}\n.no-errors[_ngcontent-%COMP%] {\n  display: none;\n}\n.sidebar[_ngcontent-%COMP%]   .open[_ngcontent-%COMP%] {\n  margin-top: -1px;\n  width: 55%;\n  height: 80%;\n  padding: 4px;\n  overflow-y: scroll;\n  overflow-x: hidden;\n}\n.sidebar[_ngcontent-%COMP%]   .closed[_ngcontent-%COMP%] {\n  height: 80px;\n  width: 28px;\n  margin-top: -1px;\n}\n.error-content[_ngcontent-%COMP%]   .closed[_ngcontent-%COMP%] {\n  display: none;\n}\n.error-content[_ngcontent-%COMP%] {\n  border-top: 1px solid #e0e0e0;\n  margin: -4px;\n  padding: 4px;\n}\n.error-title[_ngcontent-%COMP%]   .closed[_ngcontent-%COMP%] {\n  transform: rotate(90deg);\n  margin-top: 14px;\n}\n.no-padding[_ngcontent-%COMP%] {\n  margin-left: -2rem;\n  margin-right: -2rem;\n}\n.center[_ngcontent-%COMP%] {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  height: 100vh;\n}\n.form-container[_ngcontent-%COMP%] {\n  display: flex;\n  flex-direction: column;\n  justify-content: space-between;\n}\n.button-set[_ngcontent-%COMP%] {\n  margin: 0 -2rem;\n}\n.button-set[_ngcontent-%COMP%]   button[_ngcontent-%COMP%] {\n  height: 4rem;\n  align-items: baseline;\n  min-width: 50%;\n}\n\n.omrs-breakpoint-gt-tablet[_nghost-%COMP%]   .form-container[_ngcontent-%COMP%], .omrs-breakpoint-gt-tablet   [_nghost-%COMP%]   .form-container[_ngcontent-%COMP%] {\n  height: calc(100vh - 6rem);\n  margin: 0 2rem;\n}\n.omrs-breakpoint-gt-tablet[_nghost-%COMP%]   .button-set[_ngcontent-%COMP%], .omrs-breakpoint-gt-tablet   [_nghost-%COMP%]   .button-set[_ngcontent-%COMP%] {\n  padding: 0rem;\n}\n\n.omrs-breakpoint-lt-desktop[_nghost-%COMP%]   .form-container[_ngcontent-%COMP%], .omrs-breakpoint-lt-desktop   [_nghost-%COMP%]   .form-container[_ngcontent-%COMP%] {\n  height: calc(100vh - 6rem);\n  margin: 0 2rem;\n}\n.omrs-breakpoint-lt-desktop[_nghost-%COMP%]   .button-set[_ngcontent-%COMP%], .omrs-breakpoint-lt-desktop   [_nghost-%COMP%]   .button-set[_ngcontent-%COMP%] {\n  padding: 1.5rem 1rem;\n  background-color: #ffffff;\n}\n.loader-container[_ngcontent-%COMP%] {\n  height: 100vh;\n}\n.loader[_ngcontent-%COMP%] {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 50%;\n}\n.encounterHeader[_ngcontent-%COMP%] {\n  font-family: "IBM Plex Sans", sans-serif;\n  font-size: 14px;\n  line-height: 22px;\n  font-weight: 600;\n  letter-spacing: 0.16px;\n  border-bottom: 1px solid var(--brand-03);\n  padding: 0.625rem;\n}']}),n})();function xe(n,c){1&n&&r._UZ(0,"my-app-fe-wrapper")}let Ae=(()=>{class n{constructor(){this.title="ampath-esm-angular-form-entry"}ngOnInit(){this.sub=B.subscribe(e=>{this.view=e.view},e=>{})}ngOnDestroy(){this.sub&&this.sub.unsubscribe()}}return n.\u0275fac=function(e){return new(e||n)},n.\u0275cmp=r.Xpm({type:n,selectors:[["my-app-root"]],decls:1,vars:1,consts:[[4,"ngIf"]],template:function(e,t){1&e&&r.YNc(0,xe,1,0,"my-app-fe-wrapper",0),2&e&&r.Q6J("ngIf","form"===t.view)},directives:[E.O5,Ee],styles:[""]}),n})();var Te=d(6086);let ce=(()=>{class n{constructor(e,t){this.http=e,this.windowRef=t,this.v="custom:(uuid,display,identifiers:(identifier,uuid,preferred,location:(uuid,name),identifierType:(uuid,name,format,formatDescription,validator)),person:(uuid,display,gender,birthdate,dead,age,deathDate,birthdateEstimated,causeOfDeath,preferredName:(uuid,preferred,givenName,middleName,familyName),attributes:(uuid,display,value,attributeType,dateCreated,dateChanged),preferredAddress:(uuid,preferred,address1,address2,cityVillage,longitude,stateProvince,latitude,country,postalCode,countyDistrict,address3,address4,address5,address6,address7)))"}getUrl(){return this.windowRef.openmrsRestBase+"patient"}searchPatient(e,t=!1,o=null){const i=this.getUrl(),s=(new g.LE).set("q",e).set("includeDead","true").set("v",o&&o.length>0?o:this.v);return this.http.get(i,{params:s}).pipe((0,h.U)(a=>a.results))}getPatientByUuid(e,t=!1,o=null){let i=this.getUrl();i+="/"+e;const s=(new g.LE).set("v",o&&o.length>0?o:this.v);return this.http.get(i,{params:s})}saveUpdatePatientIdentifier(e,t,o){if(!o||!e)return null;const i=this.getUrl()+"/"+e+"/identifier/"+t,s=new g.WM({"Content-Type":"application/json"});return this.http.post(i,JSON.stringify(o),{headers:s}).pipe((0,h.U)(a=>a.patient))}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(g.eN),r.LFG(R.X))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),De=(()=>{class n{constructor(e,t){this.patientResourceService=e,this.encounterResource=t,this.currentlyLoadedPatient=new f.BehaviorSubject(null),this.currentlyLoadedPatientUuid=new f.BehaviorSubject(null),this.isBusy=new f.BehaviorSubject(!1)}setCurrentlyLoadedPatientByUuid(e){return null!==this.currentlyLoadedPatient.value?this.currentlyLoadedPatient.value.uuid!==e&&this.fetchPatientByUuid(e):this.fetchPatientByUuid(e),this.currentlyLoadedPatient}fetchPatientByUuid(e){return this.currentlyLoadedPatient.next(null),this.currentlyLoadedPatientUuid.next(null),this.isBusy.next(!0),(0,f.forkJoin)(this.patientResourceService.getPatientByUuid(e,!1),this.encounterResource.getEncountersByPatientUuid(e)).subscribe(t=>{const o=t[0];o.encounters=t[1],this.currentlyLoadedPatient.next(o),this.currentlyLoadedPatientUuid.next(e),this.isBusy.next(!1)},t=>{console.error(t),this.isBusy.next(!1)})}reloadCurrentPatient(){null!==this.currentlyLoadedPatient.value&&this.fetchPatientByUuid(this.currentlyLoadedPatient.value.uuid)}resetPatientService(){this.currentlyLoadedPatient=new f.BehaviorSubject(null),this.currentlyLoadedPatientUuid=new f.BehaviorSubject(null),this.isBusy=new f.BehaviorSubject(!1)}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(ce),r.LFG(L))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac}),n})(),Be=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n}),n.\u0275inj=r.cJS({providers:[Te.Y,z,G,K,H,X,L,De,ce,ne,se.F],imports:[[E.ez,g.JF]]}),n})(),Ze=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n,bootstrap:[Ae]}),n.\u0275inj=r.cJS({providers:[Z.f,ee.n,N,te,ie,oe,W,A,T.sK,T.gM],imports:[[V.b2,T.aw.forRoot({isolate:!1}),M.GH,D.UX,ue.PW,Be]]}),n})();(0,r.G48)();const Y=(0,J.Zx)({bootstrapFunction:n=>(B.next(n),V.q6((0,J.Qe)()).bootstrapModule(Ze)),template:"<my-app-root />",NgZone:r.R0b}),Ie=Y.bootstrap,je=Y.mount,ke=Y.unmount}}]);